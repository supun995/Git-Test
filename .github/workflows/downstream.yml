name: Check Swagger Admin URIs

on:
  workflow_call:
    inputs:
      swagger_file_path:
        description: 'Path to swagger file to validate'
        required: true
        type: string
      pr_number:
        description: 'PR number for commenting (when called from upstream)'
        required: false
        type: string
      repo_owner:
        description: 'Repository owner for PR commenting'
        required: false
        type: string
      repo_name:
        description: 'Repository name for PR commenting'
        required: false
        type: string


jobs:
  check-admin-uris:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for admin in API Gateway URIs
        id: check
        continue-on-error: true
        run: |
          FILE="${{ inputs.swagger_file_path }}"

          if [ ! -f "$FILE" ]; then
            echo "‚úÖ No swagger file found: $FILE"
            exit 0
          fi
          if grep -q '"x-amazon-apigateway-integration"' "$FILE"; then
            if jq -e '.. | select(type == "object" and has("x-amazon-apigateway-integration")) | .["x-amazon-apigateway-integration"].uri | select(. != null and (. | tostring | test("admin"; "i")))' "$FILE" > /dev/null 2>&1; then
              echo "‚ùå Error: Found 'admin' in API Gateway integration URI for ${{ matrix.environment }}"
              URIS=$(jq -r '.. | select(type == "object" and has("x-amazon-apigateway-integration")) | .["x-amazon-apigateway-integration"].uri | select(. != null and (. | tostring | test("admin"; "i")))' "$FILE")
              echo "admin_uris<<EOF" >> $GITHUB_OUTPUT
              echo "$URIS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "has_admin=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "‚úÖ No 'admin' found in API Gateway integration URIs for ${{ matrix.environment }}"
            fi
          else
            echo "‚úÖ No API Gateway integrations found for ${{ matrix.environment }}"
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_call' && inputs.pr_number != '')
        uses: actions/github-script@v7
        env:
          ADMIN_URIS: ${{ steps.check.outputs.admin_uris }}
        with:
          script: |
            const envHeader = `## üîç Check for admin URI's within Swagger file - ${{ matrix.environment }}`;
            const adminUris = process.env.ADMIN_URIS || '';
            const hasIssues = adminUris !== '';

            const owner = '${{ inputs.repo_owner }}' || context.repo.owner;
            const repo = '${{ inputs.repo_name }}' || context.repo.repo;
            const issueNumber = '${{ inputs.pr_number }}' || context.issue.number;
            
            const allComments = await github.paginate(github.rest.issues.listComments, {
              owner: owner,
              repo: repo,
              issue_number: issueNumber,
              per_page: 100
            });

            const existing = allComments.find(c => c.user && c.user.login === 'github-actions[bot]' && c.body && c.body.startsWith(envHeader));

            if (hasIssues) {
              const comment = `${envHeader}\n\n‚ùå **Validation Failed**\n\nFound 'admin' in API Gateway integration URIs:\n\`\`\`\n${adminUris}\n\`\`\`\n\nPlease remove admin paths from the API Gateway as they should not be publically accessible.`;
              if (existing) {
                await github.rest.issues.updateComment({
                  owner: owner,
                  repo: repo,
                  comment_id: existing.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: owner,
                  repo: repo,
                  body: comment
                });
              }
            } else if (existing) {
              await github.rest.issues.updateComment({
                owner: owner,
                repo: repo,
                comment_id: existing.id,
                body: `${envHeader}\n\n‚úÖ All issues fixed`
              });
            }

      - name: Fail if admin found
        if: steps.check.outputs.has_admin == 'true'
        run: exit 1
